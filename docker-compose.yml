version: '3.8'

services:
  # 0. Traefik (Reverse Proxy & HTTPS)
  traefik:
    image: traefik:latest
    container_name: nis2-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Global HTTP -> HTTPS Redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - nis2-net

  # 1. NIS2 Scanner (The Core)
  scanner:
    build: .
    image: nis2scan:latest
    container_name: nis2-scanner
    volumes:
      # Use CONFIG_FILE env var or default to config.yaml
      - ${CONFIG_FILE:-./config.yaml}:/app/config.yaml
      - ./reports:/app/reports
      # Mount config dir if multiple profiles needed
      - ./configs:/app/configs
    # ports:
    #   - "8000:8000" # Exposed via Traefik now
    labels:
      - "traefik.enable=true"
      # Match any request (IP or Domain)
      - "traefik.http.routers.scanner.rule=PathPrefix(`/`)"
      - "traefik.http.routers.scanner.entrypoints=websecure"
      - "traefik.http.routers.scanner.tls=true"
      - "traefik.http.services.scanner.loadbalancer.server.port=8000"
    # Command to run a scan periodically or just serve?
    # For now, we let it default to serve.
    # User can run scan via: docker-compose exec scanner python -m nis2scan.cli scan ...
    networks:
      - nis2-net

  # 2. Prometheus (Time Series DB)
  prometheus:
    image: prom/prometheus:latest
    container_name: nis2-prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./reports:/nis2-exporters:ro # Read the .prom file generated by scanner
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9090:9090"
    networks:
      - nis2-net

  # 3. Grafana (Visualization) - OPTIONAL
  # Uncomment to enable Grafana, or use: docker-compose -f docker-compose.yml -f docker-compose.grafana.yml up
  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: nis2-grafana
  #   volumes:
  #     - ./grafana/provisioning:/etc/grafana/provisioning
  #     - grafana-data:/var/lib/grafana
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #   ports:
  #     - "3000:3000"
  #   depends_on:
  #     - prometheus
  #   networks:
  #     - nis2-net

  # 4. Node Exporter (Host Metrics + Scan Results)
  node-exporter:
    image: prom/node-exporter:latest
    container_name: nis2-node-exporter
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
      # IMPORTANT: Mount the reports directory where scanner writes .prom files
      - ./reports:/var/lib/node_exporter/textfile_collector:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.textfile.directory=/var/lib/node_exporter/textfile_collector'
    networks:
      - nis2-net

networks:
  nis2-net:
    driver: bridge

# Volumes section - uncomment if using Grafana
# volumes:
#   grafana-data:
